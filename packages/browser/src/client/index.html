<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vitest Browser Runner</title>
    <style>
      html {
        overflow: hidden;
        padding: 0;
        margin: 0;
      }
      body {
        padding: 0;
        margin: 0;
      }
      #vitest-ui {
        width: 100vw;
        height: 100vh;
        border: none;
      }
    </style>
  </head>
  <body>
    <iframe id="vitest-ui" src=""></iframe>
    <script>
      const modules = new WeakMap()
      const moduleCache = new Map()

      // this method receives a module object or "import" promise that it resolves and keeps track of
      // and returns a hijacked module object that can be used to mock module exports
      function wrapModule(module) {
        if (module instanceof Promise) {
          moduleCache.set(module, { promise: module, evaluted: false })
          return module
            .then(m => wrapModule(m))
            .finally(() => moduleCache.delete(module))
        }
        const cached = modules.get(module)
        if (cached)
          return cached
        const hijacked = Object.assign({ [Symbol.toStringTag]: 'Module' }, module)
        modules.set(module, hijacked)
        return hijacked
      }

      window.__vitest_module_cache__ = moduleCache
      window.__vitest_wrap_module__ = wrapModule
    </script>
    <script type="module" src="/main.ts"></script>
  </body>
</html>
